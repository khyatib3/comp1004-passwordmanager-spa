<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PasswordHaven - Single Page Application</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /*hiding all sections by default*/
        .section { display: none; }
        .active { display: block; }
    </style>
</head>
<body>
<!-- Navigation bar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="#" onclick="showSection('home')">PasswordHaven</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('home')">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="checkLoginBeforeViewAccounts()">View Accounts</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('addAccount')">Add Account</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- center section text-->
<section id="home" class="section active text-center text-white align-items-center mt-3" style="background: #4A90E2; padding-top: 5rem;">
    <div class="container">
        <h1 class="display-4">Secure Your Passwords with PasswordHaven</h1>
        <p class="lead">The safest and easiest way to manage your passwords and accounts.</p>
        <button class="btn btn-light btn-lg mt-3" data-bs-toggle="modal" data-bs-target="#createPHAccountModal">Create Account</button>
        <button class="btn btn-light btn-lg mt-3" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
    </div>
</section>

<!-- View accounts section-->
<section id="viewAccounts" class = "section container mt-5">
    <h2 class="text-center mb-4">Your Stored Accounts</h2>
    <!-- headers for the table-->
    <div class = "row text-center fw bold border-bottom pb-2">
        <div class = "col-4">Accounts</div>
        <div class = "col-4">Date Added</div>
        <div class = "col-4">Credentials</div>

    </div>
    <!-- accounts list vertical-->
    <div class="row">
        <div class="col-12 mb-3">
            <div class="row align-items-center">
                <div class="col-4 fw bold">Instagram</div>
                <div class="col-4 text-center">01-07-2024</div>
                <div class="col-4 text-center">
                    <a href="#" class="btn btn-primary btn-sm">View Credentials</a>
                </div>
            </div>
        </div>
    </div>

        <div class="row">
            <div class="col-12 mb-3">
                <div class="row align-items-center">
                    <div class="col-4 fw bold">LinkedIn</div>
                    <div class="col-4 text-center">03-17-2022</div>
                    <div class="col-4 text-center">
                        <a href="#" class="btn btn-primary btn-sm">View Credentials</a>
                    </div>
                </div>
            </div>
        </div>

            <div class="row">
                <div class="col-12 mb-3">
                    <div class="row align-items-center">
                        <div class="col-4 fw bold">GitHub</div>
                        <div class="col-4 text-center">11-27-2024</div>
                        <div class="col-4 text-center">
                            <a href="#" class="btn btn-primary btn-sm">View Credentials</a>
                        </div>
                    </div>
                </div>
            </div>
</section>

<!-- create passwordHaven account modal pop up-->
<div class="modal fade" id="createPHAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPHAccountModalLabel">Create PasswordHaven account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label>Email:</label>
                <input type="email" id="signUpEmail" class="form-control">
                <label>Password:</label>
                <input type="password" id="signUpPassword" class="form-control">
                <p id="signUpMsg" class="mt-2 text-danger"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="User.handleSignUp()"> Create PasswordHaven Account</button>
                <button class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#generatePasswordModal" onclick="PasswordGenerator.showGeneratedPassword()">Generate Password</button>
            </div>
        </div>
    </div>
</div>

<!-- generate password modal -->
<div class="modal fade" id="generatePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class ="modal-title" id="generatePasswordModalLabel">Generated Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label>Here is your randomly generated password. Pleasy copy it:</label>
                <label></label>
            </div>
        </div>
    </div>
</div>


<!-- login form pop up modal-->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">Login to PasswordHaven</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label>Email:</label>
                <input type="email" id="loginEmail" class="form-control">
                <label>Password:</label>
                <input type="password" id="loginPassword" class="form-control">
                <p id="loginMsg" class="mt-2 text-danger"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="User.handleLogin()">Login</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<!-- function to show the relevant section when needed, so all sections don't get displayed automatically-->
<script>
    function showSection(sectionId){
        //hiding all the sections
        document.querySelectorAll('.section').forEach(section =>{
            section.classList.remove('active');
        })

        //then showing the selected section
        selectedSection = document.getElementById(sectionId);
        if(selectedSection){
            selectedSection.classList.add('active');
        }else {
            console.error("Couldn't find section:", sectionId);
        }
    }

    //method that checks whether the suer has logged into PH before they choose to see accounts.
    //ensures security
    function checkLoginBeforeViewAccounts(){
        if(localStorage.getItem("loggedIn") !== "true"){
            alert("You must login to PasswordHaven first!");
            showSection("home");
            return;
        }
        showSection("viewAccounts");
    }

    class User {
        constructor(username, password) {
            this.username = username;
            this.password = password; // Store hashed password
        }

        //adding user to local storage
          static saveUser(username, password) {
            let a = localStorage.getItem("user");
            if (a !== null) {
                alert("An account already exists. Please login!")
                return false;
            }

            let newUser = new User(username, password); //initiating an instance of the user
            localStorage.setItem("user", JSON.stringify(newUser));// adding the user to local storage
            return true;
        }

        //retrieving the user's details from local storage
        static getUser() {
            let userInfo = localStorage.getItem("user");
            return userInfo ? JSON.parse(userInfo) : null;
        }


        static login(username, inputPassword) {
            let storedUser = User.getUser();
            if (storedUser == null) {
                return false;
            }
            return storedUser.username === username && storedUser.password === inputPassword;
        }

        //method which handles the user signing up to password haven
        static handleSignUp() {
            //retrieving the email and password used in the fields
            let username = document.getElementById('signUpEmail').value;
            let password = document.getElementById('signUpPassword').value;
            let signUpMsg = document.getElementById('signUpMsg');

            //in the case that the user doesn't fill in all the fields
            if (username === '' || password === '') {
                signUpMsg.innerText = '⚠️ Please fill out all the details!';
                signUpMsg.classList.remove('text-success');
                signUpMsg.classList.add('text-danger');
                return;
            }

            let success = User.saveUser(username, password);

            if (success) {
                //changing the sign-up message to notify the user
                signUpMsg.innerText = 'Your account was created successfully! Please login now!';
                signUpMsg.classList.remove('text-danger');
                signUpMsg.classList.add('text-success');

                //clearing the input fields after successful creation
                document.getElementById('signUpEmail').value = "";
                document.getElementById('signUpPassword').value = "";

                //closing the modal afterward
                setTimeout(()=>{
                    let signUpModal = bootstrap.Modal(document.getElementById('createPHAccountModal'));
                    if (signUpModal) {
                        signUpModal.hide();
                    }
                }, 1000); //close after 1 second

            } else {
                signUpMsg.innerText = '⚠️ Your account with us already exists! Please login.';
                signUpMsg.classList.remove('text-success');
                signUpMsg.classList.add('text-danger');
            }

        }

        //function that deals with user logging into password haven
        static handleLogin() {
            let email = document.getElementById('loginEmail').value;
            let password = document.getElementById('loginPassword').value;
            let loginMsg = document.getElementById('loginMsg');

            if (User.login(email, password)) {
                localStorage.setItem("loggedIn", "true");

                loginMsg.innerHTML = "Successful Login!";
                loginMsg.classList.remove('text-danger');
                loginMsg.classList.add('text-success');

                //closing the modal afterward
                setTimeout(()=>{
                    let loginModal = bootstrap.Modal(document.getElementById('createPHAccountModal'));
                    if (loginModal) {
                        loginModal.hide();
                    }
                }, 1000); //close after 1 second
            } else {
                loginMsg.innerHTML = " ❌ Invalid details entered!";
            }
        }
    }

    class Account{
        constructor(siteName, url, username, password, dateAdded) {
            this.siteName = siteName;
            this.url = url;
            this.username = username;
            this.password = this.encryptPassword(password);
            this.dateAdded = dateAdded;
        }

        static async encryptPassword(password) {
            //first generate a random salt
            const salt = crypto.getRandomValues(new Uint8Array(16));

            //converting the Uint8Array into a normal javascript array
            //and converting each byte into a hexadecimal string, joined together
            //this way the salt becomes readable to humans
            const saltHex = Array.from(salt).map(b => b.toString(16).padStart(2, '0').join(''));

            //prepending the alt to the password
            const saltedPassword = saltHex + password;

            //encoding the salted password to a Uint8Array
            const encoder = new TextEncoder();
            const data = encoder.encode(saltedPassword);

            //hash the salted password using SHA-256 encryption
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0').join(''));

            //store the salt and the hash
            return {salt : saltHex, hash: hashHex};
        }

        static async decryptPassword(password){

        }

    }

    class PasswordManager {
        static saveAccount(site, username, password) {
            let accounts = JSON.parse(localStorage.geetItem("accounts")) || [];
            accounts.push({site, username, password: btoa(password)});
            localStorage.setItem("accounts", JSON.stringify(accounts));
        }

        //function to retrieve the accounts from localStorage
        static getAccounts() {
            return JSON.parse(localStorage.getItem("accounts")) || [];
        }

        saveNewAccount(){
            let site = document.getElementById('siteName').value;
            let email = document.getElementById('email').value;
            let password = document.getElementById('password').value;

            PasswordManager.saveAccount(site, email, password);

        }


    }

    class PasswordStrengthValidator {
        static checkStrength(password) {
            const strongRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
            return strongRegex.test(password) ? "Strong" : "Weak";
        }
    }

    class PasswordGenerator {
        static generatePassword() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()";
            let password = "";
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        static showGeneratedPassword(){
            let generatedPassword = PasswordManager.generatePassword();
            document.getElementById('generatedPasswordText').innerText = generatedPassword.toString();
        }
    }

</script>
</body>
</html>